# NetFlow DDoS Detector (NFDD)

–î–µ—Ç–µ–∫—Ç–æ—Ä DDoS/UDP-—Ñ–ª—É–¥–∞ –ø–æ –¥–∞–Ω–Ω—ã–º nfcapd/nfdump —Å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ–º –≤ Telegram.

---

## –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã

–°–∫—Ä–∏–ø—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —á–µ—Ç—ã—Ä—ë—Ö –ø—Ä–æ–≥—Ä–∞–º–º (`check_deps` –≤ `bin/detector.sh`). –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (`find`, `awk`, `grep`, `cut`, `date`, `mkdir` –∏ —Ç.–¥.) –≤—Ö–æ–¥—è—Ç –≤ –±–∞–∑–æ–≤—É—é –ø–æ—Å—Ç–∞–≤–∫—É Linux (GNU coreutils, grep, gawk).

| –ü—Ä–æ–≥—Ä–∞–º–º–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤ NFDD | –ü–∞–∫–µ—Ç (Debian/Ubuntu) | –ü–∞–∫–µ—Ç (RHEL/CentOS/Rocky/Fedora) |
|-----------|-------------------|------------------------|----------------------------------|
| **nfdump** | –ß—Ç–µ–Ω–∏–µ nfcapd, –∞–≥—Ä–µ–≥–∞—Ü–∏—è flow'–æ–≤ | `nfdump` | `nfdump` (—á–∞—Å—Ç–æ –∏–∑ EPEL) |
| **curl** | –ó–∞–ø—Ä–æ—Å—ã –∫ Telegram Bot API | `curl` | `curl` |
| **jq** | –°–±–æ—Ä–∫–∞ JSON –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram | `jq` | `jq` |
| **whois** | AS lookup (whois.cymru.com) | `whois` | `whois` |

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**

```bash
# Debian / Ubuntu
sudo apt update
sudo apt install -y nfdump curl jq whois

# RHEL / CentOS / Rocky / Alma (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–∏—Ç–µ EPEL)
sudo dnf install -y epel-release
sudo dnf install -y nfdump curl jq whois
```

–ë–µ–∑ –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö —á–µ—Ç—ã—Ä—ë—Ö –ø—Ä–æ–≥—Ä–∞–º–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤—ã–≤–µ–¥–µ—Ç `Missing required tools: ...` –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫

–ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ (—Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å –≤ `bin/`):

```bash
./bin/detector.sh [–û–ü–¶–ò–ò]
```

**–û–ø—Ü–∏–∏:**

| –û–ø—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `--config FILE` | –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `etc/detector.conf`) |
| `--dry-run` | –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ Telegram; –≤—ã–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥ |
| `--debug` | –í–∫–ª—é—á–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞ DEBUG |
| `-h`, `--help` | –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –æ–ø—Ü–∏—è–º |

**–ü—Ä–∏–º–µ—Ä—ã:**

```bash
# –û–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ (–∫–æ–Ω—Ñ–∏–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
./bin/detector.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
./bin/detector.sh --dry-run

# –°–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ –∏ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
./bin/detector.sh --config /etc/nfdd.conf --debug

# –°–ø—Ä–∞–≤–∫–∞
./bin/detector.sh --help
```

### –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

1. **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã** (—Å–º. —Ç–∞–±–ª–∏—Ü—É –≤—ã—à–µ): `nfdump`, `curl`, `jq`, `whois`.

2. **–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥** (—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å):
   ```bash
   cp etc/detector.conf.example etc/detector.conf
   nano etc/detector.conf
   ```
   –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞—Ç—å: `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID`, `NFSEN_BASE`.

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏:**
   ```bash
   ./bin/detector.sh --dry-run
   ```

4. **–î–æ–±–∞–≤–∏—Ç—å –≤ cron** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç):
   ```bash
   echo "*/5 * * * * root /opt/nfdd/bin/detector.sh" >> /etc/cron.d/nfdd
   ```

–ö–∞—Ç–∞–ª–æ–≥–∏ –ª–æ–≥–æ–≤, –∫—ç—à–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (–µ—Å–ª–∏ –Ω–µ—Ç `setup.sh`).

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
bin/detector.sh          ‚Üê –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
lib/log.sh               ‚Üê –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (stdout + —Ñ–∞–π–ª)
lib/telegram.sh          ‚Üê –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Bot API
lib/as_lookup.sh         ‚Üê whois —Å TTL-–∫—ç—à–µ–º
lib/dedup.sh             ‚Üê –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤
lib/nfdump_analysis.sh   ‚Üê —Ä–∞–±–æ—Ç–∞ —Å nfdump
lib/classify.sh          ‚Üê –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —É–≥—Ä–æ–∑—ã
etc/detector.conf        ‚Üê –∫–æ–Ω—Ñ–∏–≥ (–Ω–µ –≤ git ‚Äî —Å–º. .gitignore)
etc/detector.conf.example ‚Üê —à–∞–±–ª–æ–Ω –∫–æ–Ω—Ñ–∏–≥–∞
```

–ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —Ç–∞–∫: `./bin/detector.sh` –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî —Å–∫—Ä–∏–ø—Ç —Å–∞–º –Ω–∞—Ö–æ–¥–∏—Ç `etc/detector.conf` –∏ `lib/*.sh` –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è. –°–µ–∫—Ä–µ—Ç—ã —Ç–æ–ª—å–∫–æ –≤ `etc/detector.conf`; –∫–æ–Ω—Ñ–∏–≥ –≤ `.gitignore` –∏ `.cursorignore`.

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞** ‚Äî —Å–∫—Ä–∏–ø—Ç –∏—â–µ—Ç –≤ `NFSEN_BASE` –≤—Å–µ —Ñ–∞–π–ª—ã `nfcapd.20*` (–≤ –∫–æ—Ä–Ω–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –∏–ª–∏ –≤ –∏–µ—Ä–∞—Ä—Ö–∏–∏ NfSen –¥–æ 4 —É—Ä–æ–≤–Ω–µ–π) –∏ –±–µ—Ä—ë—Ç **–Ω–æ–≤–µ–π—à–∏–π** –ø–æ –∏–º–µ–Ω–∏ (—Ñ–æ—Ä–º–∞—Ç `nfcapd.YYYYMMDDhhmm`).

2. **–§–∏–ª—å—Ç—Ä –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è** ‚Äî –ø–æ –æ–¥–Ω–æ–º—É nfcapd-—Ñ–∞–π–ª—É –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **nfdump**:
   - —Ñ–∏–ª—å—Ç—Ä: `NFDUMP_FILTER` –∏ —Ç—Ä–∞—Ñ–∏–∫ –∏–∑ –≤–∞—à–∏—Ö —Å–µ—Ç–µ–π `INTERNAL_NETS` (–∏—Å—Ö–æ–¥—è—â–∏–π);
   - –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –ø–∞—Ä–µ **srcip,dstip** (`-A srcip,dstip`);
   - **—Ç–æ–ø-N** –∑–∞–ø–∏—Å–µ–π (`-n NFDUMP_TOP_N`) —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é (`NFDUMP_TOP_SORT`, —Å–º. –Ω–∏–∂–µ).

3. **–ü–æ—Ä–æ–≥ –ø–æ flow'–∞–º** ‚Äî –≤ —Ç–æ–ø –ø–æ–ø–∞–¥–∞—é—Ç –ø–∞—Ä—ã SRC‚ÜíDST; –∏–∑ –≤—ã–≤–æ–¥–∞ nfdump —Å–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–æ–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö **—á–∏—Å–ª–æ flow'–æ–≤** –±–æ–ª—å—à–µ `THRESHOLD_SUSPICIOUS`. –≠—Ç–æ –∏ –µ—Å—Ç—å ¬´–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ¬ª –ø–∞—Ä—ã.

4. **–£—Ä–æ–≤–Ω–∏ —É–≥—Ä–æ–∑—ã** ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–∞–∫–æ–π –ø–∞—Ä—ã –ø–æ —á–∏—Å–ª—É flow'–æ–≤ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä:
   - –≤—ã—à–µ `THRESHOLD_CRITICAL` ‚Üí üî• CRITICAL FLOOD  
   - –≤—ã—à–µ `THRESHOLD_HEAVY` ‚Üí üî¥ HEAVY FLOOD  
   - –≤—ã—à–µ `THRESHOLD_FLOOD` ‚Üí üü† FLOOD  
   - –≤—ã—à–µ `THRESHOLD_SUSPICIOUS` ‚Üí üü° Suspicious  

5. **–î–µ–¥—É–ø –∏ –∞–ª–µ—Ä—Ç—ã** ‚Äî –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ –ø–∞—Ä–∞ SRC‚ÜíDST –Ω–µ –∞–ª–µ—Ä—Ç–∏—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ `ALERT_DEDUP_TTL` —Å–µ–∫—É–Ω–¥. –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä—ã —É—Ö–æ–¥—è—Ç –≤ Telegram —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π AS –ø–æ dst IP.

**–ò—Ç–æ–≥:** –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å–º–æ—Ç—Ä–∏—Ç **–∏—Å—Ö–æ–¥—è—â–∏–π** —Ç—Ä–∞—Ñ–∏–∫ (internal ‚Üí external), —Å—Ç—Ä–æ–∏—Ç —Ç–æ–ø –ø–∞—Ä –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫—Ä–∏—Ç–µ—Ä–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–æ —á–∏—Å–ª—É flow'–æ–≤), –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ—Ç –ø–∞—Ä—ã —Å —á–∏—Å–ª–æ–º flow'–æ–≤ –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ –∏ —à–ª—ë—Ç –ø–æ –Ω–∏–º –∞–ª–µ—Ä—Ç—ã —Å —É—Ä–æ–≤–Ω–µ–º —É–≥—Ä–æ–∑—ã.

---

## –¢–æ–ø –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—é (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞)

–¢–æ–ø-N –ø–∞—Ä SRC‚ÜíDST –º–æ–∂–Ω–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ —á–∏—Å–ª—É flow'–æ–≤, –Ω–æ –∏ –ø–æ –ø–∞–∫–µ—Ç–∞–º –∏–ª–∏ –±–∞–π—Ç–∞–º. –ó–∞ —ç—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ –∫–æ–Ω—Ñ–∏–≥–µ **`NFDUMP_TOP_SORT`** (—Å–º. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)). –û—Ç –Ω–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç **–ø–æ—Ä—è–¥–æ–∫** –∑–∞–ø–∏—Å–µ–π –≤ –≤—ã–≤–æ–¥–µ nfdump (–∫—Ç–æ –ø–æ–ø–∞–¥—ë—Ç –≤ —Ç–æ–ø), –∞ –æ—Ç—Å–µ—á–∫–∞ –ø–æ –ø–æ—Ä–æ–≥—É –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏–¥—É—Ç **–ø–æ —á–∏—Å–ª—É flow'–æ–≤** (–∫–æ–ª–æ–Ω–∫–∞ flows –≤ –≤—ã–≤–æ–¥–µ nfdump).

| –ó–Ω–∞—á–µ–Ω–∏–µ | –°–º—ã—Å–ª |
|----------|--------|
| `record/flows` | –¢–æ–ø –ø–æ —á–∏—Å–ª—É flow'–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) |
| `record/packets` | –¢–æ–ø –ø–æ —á–∏—Å–ª—É –ø–∞–∫–µ—Ç–æ–≤ |
| `record/bytes` | –¢–æ–ø –ø–æ –æ–±—ä—ë–º—É (–±–∞–π—Ç—ã) |

–ü—Ä–∏–º–µ—Ä: –ø—Ä–∏ `NFDUMP_TOP_SORT=record/bytes` –≤ —Ç–æ–ø –ø–æ–ø–∞–¥—É—Ç –ø–∞—Ä—ã —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —Ç—Ä–∞—Ñ–∏–∫–æ–º –≤ –±–∞–π—Ç–∞—Ö; –∞–ª–µ—Ä—Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ç—Ä–æ—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Ö, —É –∫–æ–≥–æ —á–∏—Å–ª–æ flow'–æ–≤ –≤—ã—à–µ `THRESHOLD_SUSPICIOUS`.

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `etc/detector.conf`. –û—Å–Ω–æ–≤–Ω—ã–µ:

- `NFSEN_BASE` ‚Äî –∫–∞—Ç–∞–ª–æ–≥ —Å nfcapd-—Ñ–∞–π–ª–∞–º–∏
- `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID` ‚Äî –±–æ—Ç –∏ —á–∞—Ç –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
- `TELEGRAM_CHAT_THREAD_ID` ‚Äî (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ID —Ç–æ–ø–∏–∫–∞ –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ
- `NFDUMP_TOP_SORT` ‚Äî –∫—Ä–∏—Ç–µ—Ä–∏–π —Ç–æ–ø–∞: `record/flows`, `record/packets`, `record/bytes` (—Å–º. [–¢–æ–ø –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—é](#—Ç–æ–ø-–ø–æ-–∫—Ä–∏—Ç–µ—Ä–∏—é-—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞))
- `THRESHOLD_SUSPICIOUS` ‚Äî –ø–æ—Ä–æ–≥ –ø–æ —á–∏—Å–ª—É flow'–æ–≤ –¥–ª—è –∞–ª–µ—Ä—Ç–∞
- `ALERT_DEDUP_TTL` ‚Äî —Å–µ–∫—É–Ω–¥—ã, –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∞–ª–µ—Ä—Ç –ø–æ –æ–¥–Ω–æ–π –ø–∞—Ä–µ SRC‚ÜíDST

–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω—ã –≤ `etc/detector.conf.example` —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏.

---

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–∫—Ä–∞—Ç–∫–æ)

- **nfdump** ‚Äî —á—Ç–µ–Ω–∏–µ NetFlow (nfcapd)
- **curl** ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –≤ Telegram API
- **jq** ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–±–æ—Ä–∫–∞ JSON –¥–ª—è Telegram
- **whois** ‚Äî –∑–∞–ø—Ä–æ—Å—ã –∫ whois.cymru.com –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è AS –ø–æ IP

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –∏ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ‚Äî –≤ —Ä–∞–∑–¥–µ–ª–µ [–°–∏—Å—Ç–µ–º–Ω—ã–µ –ø–∞–∫–µ—Ç—ã](#—Å–∏—Å—Ç–µ–º–Ω—ã–µ-–ø–∞–∫–µ—Ç—ã) –≤—ã—à–µ.

