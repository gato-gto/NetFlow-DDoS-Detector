# Описание проекта: NetFlow DDoS Detector (NFDD)

## 1. Назначение

**NetFlow DDoS Detector (NFDD)** — система обнаружения DDoS/UDP-флуда по данным **nfcapd/nfdump** (NetFlow). При превышении порогов по числу flow'ов для пар источник→назначение скрипт формирует алерты и отправляет их в **Telegram**.

Использование: мониторинг аномалий UDP-трафика, раннее оповещение о возможных DDoS/флуде, привязка к автономным системам (AS) через whois.

---

## 2. Структура проекта

```
bin/detector.sh          ← оркестратор, только бизнес-логика
lib/log.sh               ← логирование (stdout + файл)
lib/telegram.sh          ← отправка через Bot API
lib/as_lookup.sh         ← whois с TTL-кэшем
lib/dedup.sh             ← дедупликация алертов
lib/nfdump_analysis.sh   ← работа с nfdump
lib/classify.sh          ← классификация угрозы
etc/detector.conf        ← конфиг отдельно от кода
```

Оркестратор не содержит секретов — все токены и пути в `etc/detector.conf`; код можно коммитить в git. Файл конфига с реальными токенами в репозиторий не попадает (используйте `.gitignore` или шаблон `etc/detector.conf.example`).

**Важно:** скрипт ожидает запуск из `bin/` и ищет `etc/detector.conf` и `lib/*.sh` относительно корня проекта. Если файлы лежат в корне — создайте `bin/`, `lib/`, `etc/` и перенесите файлы по схеме выше.

---

## 3. Конкретные исправления (относительно монолитного оригинала)

| Что исправлено | Как сделано |
|----------------|-------------|
| **Токены в коде** | Вынесены в `etc/detector.conf` — скрипт без секретов, можно коммитить в git |
| **JSON для Telegram** | Собирается через `jq` — строковая конкатенация ломалась на `"` или `\n` в AS-имени |
| **AS-кэш** | Раньше записи жили вечно; теперь TTL (по умолчанию 24 ч), устаревшие инвалидируются |
| **Повторные алерты** | Дедупликация в `lib/dedup.sh`: пара SRC→DST не слает алерт снова в течение 5 минут (настраивается) |
| **Зависимости** | `check_deps()` в начале — падает с понятной ошибкой, если нет `jq`/`nfdump`/`whois`/`curl` |
| **Тестирование** | Флаги `--dry-run` и `--debug` — проверка без реальной отправки в Telegram |
| **Надёжность скрипта** | `set -euo pipefail` — падение на первой ошибке, а не продолжение в сломанном состоянии |
| **Классификация** | Один `if/elif/elif/...` в `classify_flow()`; в оригинале — три отдельных `if` с `[ -z "$LEVEL" ]`, запутанно и не идиоматично |

---

## 4. Общая архитектура (справочно)

| Компонент | Файл | Роль |
|-----------|------|------|
| **Оркестратор** | `bin/detector.sh` | Точка входа: загрузка конфига и библиотек, поиск nfcapd-файла, запуск анализа, дедупликация, сбор алертов, отправка в Telegram |
| **Логирование** | `lib/log.sh` | Структурированный лог (консоль + файл), уровни INFO/WARN/ERROR/DEBUG |
| **Telegram** | `lib/telegram.sh` | Отправка через Bot API с безопасной сборкой JSON через `jq` |
| **AS lookup** | `lib/as_lookup.sh` | Определение AS по IP (whois.cymru.com) с TTL-кэшем в файле |
| **Дедупликация** | `lib/dedup.sh` | Подавление повторных алертов по паре SRC→DST в течение заданного TTL |
| **Анализ nfdump** | `lib/nfdump_analysis.sh` | Поиск последнего nfcapd-файла, разбор интервала, запуск nfdump и парсинг вывода (TSV) |
| **Классификация** | `lib/classify.sh` | Уровень угрозы по числу flow'ов: Suspicious / FLOOD / HEAVY / CRITICAL |
| **Конфигурация** | `etc/detector.conf` | Пути, пороги, Telegram, TTL кэшей |

---

## 5. Поток данных

1. **Запуск**  
   `detector.sh` загружает `etc/detector.conf`, подключает все `lib/*.sh`, проверяет наличие `nfdump`, `curl`, `jq`, `whois`.

2. **Поиск данных**  
   В каталоге `NFSEN_BASE` (например, профили NfSen) ищется последний файл `nfcapd.20*` на глубине 4, из имени извлекается дата/время интервала.

3. **Анализ nfdump**  
   Запускается:
   - фильтр по UDP и по внутренним сетям (`INTERNAL_NETS`, например `src net 10.0.0.0/8`);
   - агрегация по паре srcip,dstip с сортировкой по числу flow'ов, берётся топ-N записей;
   - порог `THRESHOLD_SUSPICIOUS`: в вывод попадают только пары с числом flow'ов выше порога.
   Результат — строки TSV: `SRC DST FLOWS PKTS BYTES`.

4. **Обработка каждой строки**  
   - Классификация по числу flow'ов → уровень (Suspicious / FLOOD / HEAVY / CRITICAL).  
   - Дедупликация: если пара SRC→DST уже алертилась недавно (в пределах `ALERT_DEDUP_TTL`), запись пропускается.  
   - Для назначения (DST) выполняется AS lookup (с кэшем и TTL).  
   - Пара фиксируется в дедуп-состоянии, в сообщение добавляется строка с уровнем, IP, flows/pkts/bytes и AS.

5. **Отправка**  
   Собранный текст (subject + тело с HTML-разметкой) отправляется в Telegram через `send_telegram`. В режиме `--dry-run` отправка не выполняется, сообщение только выводится в лог.

---

## 6. Конфигурация (`detector.conf`)

| Параметр | Назначение |
|----------|------------|
| `NFSEN_BASE` | Корень каталога с nfcapd-файлами (например, профили NfSen) |
| `LOG_FILE` | Файл лога детектора |
| `AS_CACHE_FILE` | Файл кэша whois (IP → ASN, AS name) |
| `STATE_DIR` | Каталог состояния дедупликации (файлы по парам SRC→DST) |
| `NFDUMP_FILTER` | Фильтр nfdump (по умолчанию `proto udp`) |
| `NFDUMP_TOP_N` | Сколько топ-пар выводить |
| `INTERNAL_NETS` | Фильтр «внутренних» сетей (источники), например `src net 10.0.0.0/8` |
| `THRESHOLD_SUSPICIOUS` | Порог flow'ов, выше которого пара считается подозрительной |
| `THRESHOLD_FLOOD`, `THRESHOLD_HEAVY`, `THRESHOLD_CRITICAL` | Пороги для уровней FLOOD / HEAVY / CRITICAL |
| `AS_CACHE_TTL` | Время жизни записи в AS-кэше (секунды) |
| `TELEGRAM_TOKEN`, `TELEGRAM_CHAT_ID` | Токен бота и ID чата для алертов |
| `TELEGRAM_CHAT_THREAD_ID` | ID топика в супергруппе (опционально; пусто — обычный чат) |
| `TELEGRAM_API_URL` | URL API Telegram |
| `ALERT_DEDUP_TTL` | Секунды, в течение которых не повторять алерт по той же паре SRC→DST |

Конфиг с реальными токенами не коммитить; использовать `.gitignore` или шаблон `etc/detector.conf.example`.

---

## 7. Зависимости

- **nfdump** — чтение nfcapd и агрегация flow'ов  
- **curl** — запросы к Telegram API  
- **jq** — безопасная сборка JSON для сообщений  
- **whois** — запросы к whois.cymru.com для AS  

Проверка выполняется в начале `detector.sh` (`check_deps`); при отсутствии одной из команд скрипт завершается с ошибкой.

---

## 8. Запуск и развёртывание

- Запуск:  
  `./bin/detector.sh [--config /path/to/detector.conf] [--dry-run] [--debug]`
- `--dry-run` — не отправлять в Telegram, только вывести сообщение в лог.  
- Обычно скрипт ставят в cron (например, каждые 5 минут).  
- Перед первым запуском нужно создать runtime-каталоги (лог, кэш, state); в README упоминается `setup.sh`, в репозитории его может не быть — тогда каталоги создаются по мере обращения (например, в `log_init` и при записи кэша/state).

---

## 9. Краткое резюме

Проект представляет собой модульный Bash-детектор DDoS/UDP-флуда по данным NetFlow (nfcapd/nfdump) — NFDD: поиск последнего снимка, агрегация по парам src/dst, фильтрация по порогам и внутренним сетям, классификация серьёзности, дедупликация алертов, обогащение данными AS и доставка уведомлений в Telegram. Конфигурация и секреты вынесены в отдельный файл; логирование, кэш AS и дедуп вынесены в отдельные скрипты для удобства поддержки и повторного использования.
